<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Certicredia</title>
    <link rel="icon" type="image/svg+xml" href="/images/logo.svg">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <img src="/images/logo.svg" alt="Certicredia">
                <span>Certicredia</span>
            </a>
        </div>
    </nav>

    <section class="section" style="margin-top: 80px;">
        <div class="container" style="max-width: 900px;">
            <h1 class="text-center mb-8">Checkout</h1>

            <div class="grid grid-2">
                <div>
                    <div class="card">
                        <h3 class="mb-6">Informazioni di Fatturazione</h3>
                        <form id="checkout-form">
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label class="form-label">Nome *</label>
                                    <input type="text" class="form-input" id="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cognome *</label>
                                    <input type="text" class="form-input" id="lastName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Azienda</label>
                                <input type="text" class="form-input" id="company">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Partita IVA</label>
                                <input type="text" class="form-input" id="vatNumber">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Indirizzo *</label>
                                <input type="text" class="form-input" id="address" required>
                            </div>
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label class="form-label">Città *</label>
                                    <input type="text" class="form-input" id="city" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">CAP *</label>
                                    <input type="text" class="form-input" id="postalCode" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Paese *</label>
                                <select class="form-select" id="country" required>
                                    <option value="IT">Italia</option>
                                    <option value="EU">Altro UE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Metodo di Pagamento *</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="bank_transfer">Bonifico Bancario</option>
                                    <option value="stripe">Carta di Credito (Stripe) - DEMO</option>
                                    <option value="paypal">PayPal - DEMO</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h3 class="mb-6">Riepilogo Ordine</h3>
                        <div id="order-summary">
                            <div class="spinner"></div>
                        </div>
                        <div id="totals" class="hidden">
                            <div class="flex-between mb-3">
                                <span>Subtotale:</span>
                                <span>€<span id="subtotal">0.00</span></span>
                            </div>
                            <div class="flex-between mb-3">
                                <span>IVA (22%):</span>
                                <span>€<span id="vat">0.00</span></span>
                            </div>
                            <div class="flex-between mb-6" style="padding-top: 1rem; border-top: 2px solid var(--color-gray-800);">
                                <span class="text-xl font-bold">Totale:</span>
                                <span class="text-2xl font-bold text-primary">€<span id="total">0.00</span></span>
                            </div>
                            <button onclick="completeOrder()" class="btn btn-accent btn-lg" style="width: 100%;">
                                Completa Ordine
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="/js/i18n.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        async function loadOrderSummary() {
            try {
                const response = await fetch('/api/ecommerce/cart', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.data.items.length === 0) {
                    window.location.href = '/prodotti';
                    return;
                }

                document.getElementById('order-summary').innerHTML = data.data.items.map(item => `
                    <div class="flex-between mb-3">
                        <span>${item.name} x${item.quantity}</span>
                        <span>€${parseFloat(item.subtotal).toFixed(2)}</span>
                    </div>
                `).join('');

                const subtotal = parseFloat(data.data.summary.subtotal);
                const vat = subtotal * 0.22;
                const total = subtotal + vat;

                document.getElementById('subtotal').textContent = subtotal.toFixed(2);
                document.getElementById('vat').textContent = vat.toFixed(2);
                document.getElementById('total').textContent = total.toFixed(2);
                document.getElementById('totals').classList.remove('hidden');
            } catch (error) {
                console.error(error);
            }
        }

        async function completeOrder() {
            const form = document.getElementById('checkout-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const billingData = {
                billingEmail: document.getElementById('email').value,
                billingFirstName: document.getElementById('firstName').value,
                billingLastName: document.getElementById('lastName').value,
                billingCompany: document.getElementById('company').value,
                billingVatNumber: document.getElementById('vatNumber').value,
                billingAddress: document.getElementById('address').value,
                billingCity: document.getElementById('city').value,
                billingPostalCode: document.getElementById('postalCode').value,
                billingCountry: document.getElementById('country').value,
                paymentMethod: document.getElementById('paymentMethod').value
            };

            try {
                const response = await fetch('/api/ecommerce/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(billingData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`Ordine completato! Numero: ${data.data.order.orderNumber}`);
                    window.location.href = '/dashboard';
                } else {
                    alert('Errore: ' + data.error.message);
                }
            } catch (error) {
                alert('Errore nella creazione dell\'ordine');
            }
        }

        loadOrderSummary();
    </script>
</body>
</html>
